<!DOCTYPE html>
<html class="mcss">
<!--Created by Shuoyi Ma in 27st July 2017-->

<head>
   <script></script>
   <meta charset="UTF-8">
   <link rel="stylesheet" href="midas.css" type="text/css">
   <!-- not using old css file any more <link rel="stylesheet" href="mhttpd.css">-->
   <script src="midas.js"></script>
   <script src="mhttpd.js"></script>
   <title>MIDAS online database</title>
</head>

<body class="mcss" onload="mhttpd_init('ODB',1000,update_periodic)">

   <div id="mheader"></div>
   <div id="msidenav"></div>

   <div id="mmain">

      <table class="mmaintable" id="ODBTable">
         <!-- <div id="loader" class="mloader"></div> 
         <tr>
            <th colspan="7" class="mtableheader">Online Database Browser</th>
         </tr>
         <tr>
            <td id="actionBar" colspan="7">
               <button id="create">create</button>
               <button id="delete">delete</button>
               <input id="searchbox" type="text" placeholder="press s to search" title="case insensitive"></input>
            </td>
         </tr>
         <tr>
            <td id="currentDir" colspan="7">
            </td>
         </tr> -->
      </table>

   </div>

   <script>
      var update_timer_id;

      var global_rpc_data = null;

      var global_dir_data = null;

      var currentEditing = null;

      var custompath = "";

      var custompathcache = "";

      var subDirArray=new Array();

      const ODBTableinnerHTML = "<tr><th colspan=\"7\" class=\"mtableheader\">Online Database Browser</th></tr><tr><td id=\"actionBar\" colspan=\"7\"><button id=\"create\">create</button><button id=\"delete\">delete</button><input id=\"searchbox\" type=\"text\" placeholder=\"press s to search\" title=\"case insensitive\"></input></td><tr><td id=\"currentDir\" colspan=\"7\"></td></tr><tr><td><button id=\"allSubDirs\">ALL</button></td></tr>";

      const MODE_READ = (1 << 0)
      const MODE_WRITE = (1 << 1)
      const MODE_DELETE = (1 << 2)
      const MODE_EXCLUSIVE = (1 << 3)

      var isExpand = false;

      function updatepath(element) {
         custompath = element.id;
         update();
      }

      function updatekey(element) {
         //document.getElementById('loader').style.display = "block";
         var path = custompath + "/" + element.id;
         mjsonrpc_db_paste([path], [element.value]).then(function (rpc) {
            update();
         }).catch(function (error) {
            mjsonrpc_error_alert(error);
         });

      }



      function callback(rpc, currentDir) {

         function deleteDirsAndKeys() {
            var allDirCheckboxs = document.getElementsByClassName("sub_dir_checkbox");
            var allKeyCheckboxs = document.getElementsByClassName("key_row_checkbox");
            var allDeleteDirs = new Array();
            var allDeleteKeys = new Array();
            Array.prototype.forEach.call(allDirCheckboxs, function (element) {
               if (element.checked)
                  allDeleteDirs.push(element.id);
            });
            Array.prototype.forEach.call(allKeyCheckboxs, function (element) {
               if (element.checked)
                  allDeleteKeys.push(element.id);
            });
            if (allDeleteDirs.length == 0 && allDeleteKeys.length == 0) {
               alert("please select at least one directory or key to delete");
               return;
            }
            var allDeleteDirsStr = allDeleteDirs.map(function (ele) { return ele + "\n" });
            var allDeleteKeysStr = allDeleteKeys.map(function (ele) { return ele + "\n" });
            allDeleteDirsStr = allDeleteDirsStr.join("");
            allDeleteKeysStr = allDeleteKeysStr.join("");


            if (allDeleteDirsStr.length > 0 && allDeleteKeysStr.length > 0) {
               var confirmStr = "You are trying to delete\n\n(DIRECTORIES)\n" + allDeleteDirsStr + "\n(KEYS)\n" + allDeleteKeysStr + "\nAre you sure?";
            } else if (allDeleteDirsStr.length > 0) {
               var confirmStr = "You are trying to delete\n\n(DIRECTORIES)\n" + allDeleteDirsStr + "\nAre you sure?";
            } else if (allDeleteKeysStr.length > 0) {
               var confirmStr = "You are trying to delete\n\n(KEYS)\n" + allDeleteKeysStr + "\nAre you sure?";
            }
            if (confirm(confirmStr)) {
               var path = new Array();
               Array.prototype.forEach.call(allDirCheckboxs, function (element) {
                  if (element.checked)
                     path.push(custompath + "/" + element.id);
               });
               Array.prototype.forEach.call(allKeyCheckboxs, function (element) {
                  if (element.checked)
                     path.push(custompath + "/" + element.id);
               });
               mjsonrpc_db_delete(path).then(function (rpc) {
                  update();
               }).catch(function (error) {
                  mjsonrpc_error_alert(error);
               });
            }
         }

         var ODBTable = document.getElementById("ODBTable");
         var obj = rpc.result.data[0];

         function generateActionbar() {
            function pressKeySearch(event) {
               if (currentEditing == null && event.keyCode == 83) {
                  document.getElementById('searchbox').focus();
               }
            }

            document.addEventListener("keyup", pressKeySearch);


            document.getElementById("delete").onclick = function () { deleteDirsAndKeys(); };

         }



         function generateSub_Dir() {

            function checkAllCheckbox() {
               var allCheckboxs = document.getElementsByClassName("sub_dir_checkbox");
               Array.prototype.forEach.call(allCheckboxs, function (element) {
                  if (element.checked) {
                     element.checked = false;
                     element.style.opacity = 0.4;
                  } else {
                     element.checked = true;
                     element.style.opacity = 1;
                  }
               });
            }


            if (sub_dir.length > 0) {
               sub_dir.forEach(function (element) {


                  function showCheckbox() {
                     sub_dir_checkbox.style.opacity = 1;
                  }

                  function hideCheckbox() {
                     if (!sub_dir_checkbox.checked)
                        sub_dir_checkbox.style.opacity = 0.3;
                  }

                  function expand() {
                     sub_dir_expand_link.innerHTML = "&#9660;";
                     sub_dir_expand_link.removeEventListener('click', expand);
                     sub_dir_expand_link.addEventListener('click', fold);
                  }

                  function fold() {
                     sub_dir_expand_link.innerHTML = "&#9654;";
                     sub_dir_expand_link.removeEventListener('click', fold);
                     sub_dir_expand_link.addEventListener('click', expand);
                  }

                  function highlight() {
                     sub_dir_expand_link.style.color = "#00CC00";
                  }

                  function unhighlight() {
                     sub_dir_expand_link.style.color = "#000000";
                  }



                  var sub_dir_row = document.createElement("tr");

                  var sub_dir_checkbox = document.createElement("input");
                  var sub_dir_col = document.createElement("td");
                  var sub_dir_expand_link = document.createElement("span");
                  var sub_dir_link = document.createElement("span");



                  sub_dir_checkbox.type = "checkbox";
                  sub_dir_checkbox.title = "double click to select all";
                  sub_dir_checkbox.id = element;
                  sub_dir_checkbox.className = "sub_dir_checkbox";
                  sub_dir_checkbox.style.opacity = 0.3;
                  sub_dir_checkbox.addEventListener('mouseover', showCheckbox);
                  sub_dir_checkbox.addEventListener('mouseout', hideCheckbox);


                  sub_dir_link.innerHTML = " " + element;
                  sub_dir_link.href = "#";
                  sub_dir_link.onclick = "return false;";
                  if (element.charAt(0) != "/" && custompath.slice(-1) != "/") {
                     sub_dir_link.addEventListener('click', function () { custompath += "/" + element; update(); });
                  } else {
                     sub_dir_link.addEventListener('click', function () { custompath += element; update(); });
                  }
                  sub_dir_link.className = "modblink";

                  sub_dir_expand_link.innerHTML = "&#9654;";
                  sub_dir_expand_link.className = "modbarrow";
                  sub_dir_expand_link.href = "#";
                  sub_dir_expand_link.onclick = "return false;";
                  sub_dir_expand_link.addEventListener('click', expand);
                  sub_dir_expand_link.addEventListener('mouseover', highlight);
                  sub_dir_expand_link.addEventListener('mouseout', unhighlight);

                  sub_dir_col.appendChild(sub_dir_checkbox);
                  sub_dir_col.appendChild(sub_dir_expand_link);
                  sub_dir_col.appendChild(sub_dir_link);

                  sub_dir_col.colSpan = "3";

                  sub_dir_row.appendChild(sub_dir_col);

                  ODBTable.appendChild(sub_dir_row);

               });
               document.getElementById("allSubDirs").style.display="block";
               document.getElementById("allSubDirs").addEventListener("click", checkAllCheckbox);
            } else {
               document.getElementById("allSubDirs").style.display="none";
            }
         }

         function generateODB_Keys() {

            function checkAllCheckbox() {
               var allCheckboxs = document.getElementsByClassName("key_row_checkbox");
               Array.prototype.forEach.call(allCheckboxs, function (element) {
                  if (element.checked) {
                     element.checked = false;
                     element.style.opacity = 0.4;
                  } else {
                     element.checked = true;
                     element.style.opacity = 1;
                  }
               });
            }


            function showCheckbox(element) {
               element.style.opacity = 1;
            }

            function hideCheckbox(element) {
               if (!element.checked)
                  element.style.opacity = 0.4;
            }


            function editKey(element) {
               resetEditKey();
               currentEditing = element;
               element.style.display = "none";
               var editableKey = document.createElement("td");
               var input = document.createElement("input");
               input.id = element.id;
               input.lastvalue = element.innerText;
               input.value = element.innerText;
               document.addEventListener("keydown", function (event) {
                  if (event.keyCode == 27) resetEditKey();
                  if (event.keyCode == 13)
                     if (input.value != input.lastvalue) {
                        updatekey(input);
                     } else {
                        resetEditKey();
                     }
               });
               editableKey.appendChild(input);
               if (element.className.indexOf("expandCell") != -1) {
                  editableKey.className = "editableKey expandCell";
               } else {
                  editableKey.className = "editableKey";
               }
               var parent = element.parentNode;
               parent.insertBefore(editableKey, element);
            }

            function resetEditKey() {
               var editingKeyCells = document.getElementsByClassName("editableKey");

               Array.prototype.forEach.call(editingKeyCells, function (ele) {
                  ele.outerHTML = "";
                  delete ele;
               });

               var keyCells = document.getElementsByClassName("keyCell");

               if (currentEditing != null) {
                  if (isExpand || currentEditing.className.indexOf("expandCell") == -1)
                     currentEditing.style.display = "table-cell";
                  currentEditing = null;
               }

            }



            function expandproperty() {
               isExpand = true;

               var hidecells = document.getElementsByClassName("expandCell");

               Array.prototype.forEach.call(hidecells, function (element) {
                  element.style.display = "table-cell";
               });
               exp.removeEventListener('click', expandproperty);
               exp.addEventListener('click', foldproperty);
               exp.innerHTML = "&#8722;";
            }

            function foldproperty() {
               isExpand = false;

               var hidecells = document.getElementsByClassName("expandCell");

               Array.prototype.forEach.call(hidecells, function (element) {
                  element.style.display = "none";
               });
               exp.removeEventListener('click', foldproperty);
               exp.addEventListener('click', expandproperty)
               exp.innerHTML = "&#43;";

            }


            function sizeOfObject(object) {

               var objectList = [];
               var stack = [object];
               var bytes = 0;

               while (stack.length) {
                  var value = stack.pop();

                  if (typeof value === 'boolean') {
                     bytes += 4;
                  }
                  else if (typeof value === 'string') {
                     bytes += value.length * 2;
                  }
                  else if (typeof value === 'number') {
                     bytes += 8;
                  }
                  else if (
                     typeof value === 'object'
                     && objectList.indexOf(value) === -1
                  ) {
                     objectList.push(value);

                     for (var i in value) {
                        stack.push(value[i]);
                     }
                  }
               }
               return bytes;
            }

            if (odb_keys.length > 0) {
               var key_title_row = document.createElement("tr");
               key_title_row.className = "mODBtr";


               var key_title_checkbox = document.createElement("button");
               key_title_checkbox.id = "allElements";
               key_title_checkbox.innerText = "ALL";
               key_title_checkbox.className = "key_selectall";
               var key_title_checkall = document.createElement("th");
               key_title_checkall.appendChild(key_title_checkbox);


               var key_title = document.createElement("th");
               key_title.innerHTML = "Key";

               var value_title = document.createElement("th");
               value_title.innerHTML = "Value";

               var type_title = document.createElement("th");
               type_title.innerHTML = "Type";
               type_title.className = "expandCell";

               var val_title = document.createElement("th");
               val_title.innerHTML = "#Val";
               val_title.className = "expandCell";

               var size_title = document.createElement("th");
               size_title.innerHTML = "Size";
               size_title.className = "expandCell";

               var written_title = document.createElement("th");
               written_title.innerHTML = "Written";
               written_title.className = "expandCell";

               var mode_title = document.createElement("th");
               mode_title.innerHTML = "Mode";
               mode_title.className = "expandCell";

               var expandkey = document.createElement("div");
               expandkey.style.display = "inline";
               expandkey.style.cssFloat = "right";

               value_title.appendChild(expandkey);

               var exp = document.createElement("span");
               exp.className = "modblink";
               exp.id = "exp";
               exp.href = "#";
               exp.onclick = "return false;";
               exp.innerHTML = "&#43;";
               exp.addEventListener('click', expandproperty);

               expandkey.appendChild(exp);

               key_title_row.appendChild(key_title_checkall);
               key_title_row.appendChild(key_title);
               key_title_row.appendChild(value_title);
               key_title_row.appendChild(type_title);
               key_title_row.appendChild(val_title);
               key_title_row.appendChild(size_title);
               key_title_row.appendChild(written_title);
               key_title_row.appendChild(mode_title);

               ODBTable.appendChild(key_title_row);

               odb_keys.forEach(function (element) {
                  var key_row = document.createElement("tr");
                  key_row.className = "mODBtr";

                  var key_row_checkbox_cell = document.createElement("td");
                  key_row_checkbox_cell.className = "keyCell";
                  var key_row_checkbox = document.createElement("input");
                  key_row_checkbox.type = "checkbox";
                  key_row_checkbox.id = element;
                  key_row_checkbox.className = "key_row_checkbox";
                  key_row_checkbox.title = "double click to select all";
                  key_row_checkbox.style.opacity = 0.4;
                  key_row_checkbox.addEventListener('mouseover', function () { showCheckbox(key_row_checkbox) });
                  key_row_checkbox.addEventListener('mouseout', function () { hideCheckbox(key_row_checkbox) });
                  key_row_checkbox_cell.appendChild(key_row_checkbox);

                  var key_row_key = document.createElement("td");
                  key_row_key.innerHTML = element;
                  key_row_key.className = "keyCell";


                  var key_row_value = document.createElement("td");
                  key_row_value.innerHTML = obj[element];
                  key_row_value.id = element;
                  key_row_value.className = "keyCell mkeyCellEditable";

                  var key_row_type = document.createElement("td");
                  key_row_type.innerHTML = obj[element + "/key"]["type"];
                  key_row_type.className = "expandCell keyCell";

                  switch (obj[element + "/key"]["type"]) {
                     case 1: key_row_type.innerHTML = "BYTE"; break;
                     case 2: key_row_type.innerHTML = "SBYTE"; break;
                     case 3: key_row_type.innerHTML = "CHAR"; break;
                     case 4: key_row_type.innerHTML = "WORD"; break;
                     case 5: key_row_type.innerHTML = "SHORT"; break;
                     case 6: key_row_type.innerHTML = "DWORD"; break;
                     case 7: key_row_type.innerHTML = "INT"; break;
                     case 8: key_row_type.innerHTML = "BOOL"; break;
                     case 9: key_row_type.innerHTML = "FLOAT"; break;
                     case 10: key_row_type.innerHTML = "DOUBLE"; break;
                     case 11: key_row_type.innerHTML = "BITFIELD"; break;
                     case 12: key_row_type.innerHTML = "STRING"; break;
                     case 13: key_row_type.innerHTML = "ARRAY"; break;
                     case 14: key_row_type.innerHTML = "STRUCT"; break;
                     case 15: key_row_type.innerHTML = "KEY"; break;
                     case 16: key_row_type.innerHTML = "LINK"; break;
                     case 17: key_row_type.innerHTML = "LAST"; break;
                  }

                  var key_row_val = document.createElement("td");
                  key_row_val.innerHTML = obj[element];
                  key_row_val.className = "expandCell keyCell";

                  var key_row_size = document.createElement("td");
                  key_row_size.innerHTML = sizeOfObject(obj[element]);
                  key_row_size.className = "expandCell keyCell";

                  var key_row_written = document.createElement("td");
                  key_row_written.innerHTML = getLastWritten(element);
                  key_row_written.id = element;
                  key_row_written.className = "expandCell keyCell lastWritten";


                  var key_row_mode = document.createElement("td");
                  var access_mode = "";
                  if (obj[element + "/key"]["access_mode"] & MODE_READ) {
                     access_mode += "R";
                  }
                  if (obj[element + "/key"]["access_mode"] & MODE_WRITE) {
                     access_mode += "W";
                  }
                  if (obj[element + "/key"]["access_mode"] & MODE_DELETE) {
                     access_mode += "D";
                  }
                  if (obj[element + "/key"]["access_mode"] & MODE_EXCLUSIVE) {
                     access_mode += "E";
                  }
                  key_row_mode.innerHTML = access_mode;
                  key_row_mode.className = "expandCell keyCell";

                  key_row.appendChild(key_row_checkbox_cell);
                  key_row.appendChild(key_row_key);
                  key_row.appendChild(key_row_value);
                  key_row.appendChild(key_row_type);
                  key_row.appendChild(key_row_val);
                  key_row.appendChild(key_row_size);
                  key_row.appendChild(key_row_written);
                  key_row.appendChild(key_row_mode);

                  ODBTable.appendChild(key_row);
               });

               var hidecells = document.getElementsByClassName("expandCell");

               Array.prototype.forEach.call(hidecells, function (element) {
                  element.style.display = "none";
               });

               var keycells = document.getElementsByClassName("keyCell");

               Array.prototype.forEach.call(keycells, function (element) {
                  element.addEventListener('click', function () { resetEditKey() });
               });

               var keycells = document.getElementsByClassName("mkeyCellEditable");

               Array.prototype.forEach.call(keycells, function (element) {
                  element.addEventListener('click', function () { editKey(element); });
                  element.addEventListener('touchstart', function () { editKey(element); });
               });

               document.getElementById("allElements").addEventListener("click", checkAllCheckbox);

            }
         }

         function getLastWritten(element) {
            var last_written = Math.round(new Date().getTime() / 1000) - obj[element + "/key"]["last_written"];
            if (last_written < 60) {
               return Math.floor(last_written) + "s";
            } else if (last_written < 3600) {
               return Math.floor(last_written / 60) + "m";
            } else if (last_written < 86400) {
               return Math.floor(last_written / 3600) + "h";
            } else if (last_written < 86400 * 99) {
               return Math.floor(last_written / 86400) + "d";
            } else {
               return ">99d";
            }
         }

         function updateLastWritten() {
            var lastWrittenCells = document.getElementsByClassName("lastWritten");

            Array.prototype.forEach.call(lastWrittenCells, function (element) {
               var a = getLastWritten(element.id);
               if (element.innerHTML != getLastWritten(element.id)) {
                  element.innerHTML = getLastWritten(element.id);
               }
            });
         }


         // CALLBACK STARTS HERE


         if (global_dir_data != currentDir || JSON.stringify(global_rpc_data) != JSON.stringify(rpc.result.data)) {
            if (ODBTable.innerHTML != ODBTableinnerHTML)
               ODBTable.innerHTML = ODBTableinnerHTML;
            global_dir_data = "";
            global_rpc_data = "";
         }

         // odb directory very rarely changes
         if (global_dir_data != currentDir) {
            global_dir_data = currentDir;
            document.getElementById("currentDir").innerHTML = "";

            dirArray = currentDir.split("/");
            for (var i = 0; i < dirArray.length; i++) {
               if (i == 0) {
                  var currentDirLink = document.createElement("span");
                  currentDirLink.className = "modblink";
                  currentDirLink.innerHTML = "&#127968;";
                  currentDirLink.href = "#";
                  currentDirLink.onclick = "return false;"
                  currentDirLink.addEventListener('click', function () { custompath = "/"; update(); });
                  //                  currentDirLink.href = global_base_url + "odb.html?odbpath=";//TODO: change to correct one
               } else if (dirArray[i] != "") {
                  var currentDirLink = document.createElement("span");
                  currentDirLink.className = "modblink";
                  currentDirLink.href = "#";
                  currentDirLink.onclick = function () { updatepath(this); };

                  var link = "";
                  for (var j = 1; j <= i; j++) {
                     if (dirArray[j].charAt(0) != "/") {
                        link += "/" + dirArray[j];
                     } else {
                        link += dirArray[j];
                     }
                  }
                  currentDirLink.id = link
                  currentDirLink.innerText = dirArray[i];

                  var dir_arrow = document.createElement("span");
                  dir_arrow.innerHTML = " &#8680; "

                  document.getElementById("currentDir").appendChild(dir_arrow);
               }
               document.getElementById("currentDir").appendChild(currentDirLink);
            }



         }

         // since odb data rarely changes while browsing, if any change dynamically happens, refresh the whole page
         if (JSON.stringify(global_rpc_data) != JSON.stringify(rpc.result.data)) {
            global_rpc_data = rpc.result.data;

            if (rpc.result.data != null && rpc.result.data != undefined) {

               var sub_dir = new Array();
               var odb_keys = new Array();

               //get all keys of the data object
               var keys = Object.keys(rpc.result.data[0])

               // for each key...
               keys.forEach(function (key) {
                  // if the value of the key is not an object, then it must be a key with value
                  if (typeof obj[key] !== 'object') {
                     odb_keys.push(key);
                     // if the value of the key is an object and length is 0, then it must be a sub directory
                  } else if (Object.keys(obj[key]).length === 0) {
                     sub_dir.push(key);
                  }
                  // rest of them are key properties
               });

               generateActionbar();
               generateSub_Dir();
               generateODB_Keys();

               custompathcache = custompath;

            }
         }

         updateLastWritten();




      }


      function update() {
         if (custompath != custompathcache) {
            // document.getElementById('loader').style.display = "block";
            //window.location.replace(global_base_url + "odb.html?odbpath=" + custompath);
            window.location.href = global_base_url + "odb.html?odbpath=" + custompath;
         }
         if (custompath == "") {
            var href = decodeURIComponent(window.location.href);
            if (href.slice(-1) === "#")
               href = href.substring(0, href.length - 1);
            if (href.slice(-1) === "/")
               href = href.substring(0, href.length - 1);
            var directory = "/";
            if (href.indexOf("odb.html?odbpath=") != -1) {
               var directoryPosition = href.indexOf("odb.html?odbpath=");
               directory = href.substring(directoryPosition + "odb.html?odbpath=".length, href.length);
               odb_hostname = href;
            } else {
               if (global_base_url.slice(-1) != "/")
                  global_base_url += "/";

               odb_hostname = global_base_url + "odb.html?odbpath=";
            }
            custompath = directory;
            var paths = [directory];
         } else {
            var paths = [custompath];
         }
         mjsonrpc_db_ls(paths).then(function (rpc) {
            callback(rpc, paths[0]);
         }).then(function () {
            // document.getElementById('loader').style.display = "none";
         }).catch(function (error) {
            // mjsonrpc_error_alert(error);
         });
      }


      function update_periodic() {
         clearTimeout(update_timer_id);
         var update_period = 1000;
         update();
         update_timer_id = setTimeout('update_periodic()', update_period);
      }

      // document.getElementById("chatBox").onload = function () {
      //    var chatBox = document.getElementById("chatBox");
      //    chatBox.style.position="relative";
      //    chatBox.contentWindow.document.getElementById("mheader").style.display = "none";
      //    chatBox.contentWindow.document.getElementById("msidenav").style.display = "none";
      // }
   </script>

</body>


</html>