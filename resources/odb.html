<!DOCTYPE html>
<html class="mcss">
<!--Created by Shuoyi Ma in 27st July 2017-->

<head>
   <script></script>
   <meta charset="UTF-8">
   <link rel="stylesheet" href="midas.css" type="text/css">
   <!-- not using old css file any more <link rel="stylesheet" href="mhttpd.css">-->
   <script src="midas.js"></script>
   <script src="mhttpd.js"></script>
   <script src="controls.js"></script>
   <title>MIDAS online database</title>
</head>

<body class="mcss" onload="mhttpd_init('ODB',1000,update_periodic)">

   <div id="mheader"></div>
   <div id="msidenav"></div>

   <div id="mmain">
      <div id="mload" style="display:none">
         <table class="mmaintable" id="ODBTable">
            <!-- <div id="loader" class="mloader"></div> 
         <tr>
            <th colspan="7" class="mtableheader">Online Database Browser</th>
         </tr>
         <tr>
            <td id="actionBar" colspan="7">
               <button id="create">create</button>
               <button id="delete">delete</button>
               <input id="searchbox" type="text" placeholder="press s to search" title="case insensitive"></input>
            </td>
         </tr>
         <tr>
            <td id="currentDir" colspan="7">
            </td>
         </tr> -->
         </table>
      </div>
   </div>

   <script>
      var update_timer_id;

      var global_rpc_data = null;

      var global_dir_data = null;

      var global_rpc_subDir = null;

      var currentEditing = null;

      var custompath = "";

      var custompathcache = "";

      var subDirArray = new Array();

      const ODBTableinnerHTML = "<tr><th colspan=\"7\" class=\"mtableheader\">Online Database Browser</th></tr><tr align=\"center\"><td id=\"mgeneralBar\" colspan=\"7\"><button id=\"create\" class=\"mbutton\" onclick=\"generateCreateDlg()\">create</button><button id=\"reorder\" class=\"mbutton\" onclick=\"startReorder()\">reorder</button><button id=\"cancelReorder\" class=\"mbutton\" onclick=\"cancelReorder()\" style=\"display:none\">cancel</button><input id=\"searchbox\" type=\"text\" placeholder=\"search\" title=\"case insensitive\"></input></td></tr><tr align=\"center\" id=\"mactionBar\" class=\"mactionBar\"><td  colspan=\"7\"><button id=\"copy\" class=\"mbutton\" onclick=\"generateCopyDlg()\">copy/move</button><button id=\"rename\" class=\"mbutton\" onclick=\"generateRenameDlg()\">rename</button><button id=\"resize\" class=\"mbutton\" onclick=\"generateResizeDlg()\">resize</button><button id=\"mode\" class=\"mbutton\" onclick=\"generateAccessModeDlg()\">mode</button><button id=\"delete\" class=\"mbutton\" onclick=\"deleteDirsAndKeys()\">delete</button></td><tr><td id=\"currentDir\" colspan=\"7\"></td></tr><tr><td><input type=\"checkbox\" id=\"allSubDirs\"></input></td><div id=\"dlgCreate\" class=\"dlgFrame\" style=\"display:none\"></div></tr>";

      const MODE_READ = (1 << 0)
      const MODE_WRITE = (1 << 1)
      const MODE_DELETE = (1 << 2)
      const MODE_EXCLUSIVE = (1 << 3)

      var isExpand = false;

      function updatepath(element) {
         window.location.href = global_base_url + "odb.html?odbpath=" + element.id;
      }

      function updatekey(element) {
         //document.getElementById('loader').style.display = "block";
         var path = custompath + "/" + element.id;
         mjsonrpc_db_paste([path], [element.value]).then(function (rpc) {
            update();
         }).catch(function (error) {
            mjsonrpc_error_alert(error);
         });

      }


      function sizeOfObject(object) {

         var objectList = [];
         var stack = [object];
         var bytes = 0;

         while (stack.length) {
            var value = stack.pop();

            if (typeof value === 'boolean') {
               bytes += 4;
            }
            else if (typeof value === 'string') {
               bytes += value.length * 2;
            }
            else if (typeof value === 'number') {
               bytes += 8;
            }
            else if (
               typeof value === 'object'
               && objectList.indexOf(value) === -1
            ) {
               objectList.push(value);

               for (var i in value) {
                  stack.push(value[i]);
               }
            }
         }
         return bytes;
      }


      function getKeyType(ele) {
         switch (ele) {
            case 1: return "BYTE"; break;
            case 2: return "SBYTE"; break;
            case 3: return "CHAR"; break;
            case 4: return "WORD"; break;
            case 5: return "SHORT"; break;
            case 6: return "DWORD"; break;
            case 7: return "INT"; break;
            case 8: return "BOOL"; break;
            case 9: return "FLOAT"; break;
            case 10: return "DOUBLE"; break;
            case 11: return "BITFIELD"; break;
            case 12: return "STRING"; break;
            case 13: return "ARRAY"; break;
            case 14: return "STRUCT"; break;
            case 15: return "KEY"; break;
            case 16: return "LINK"; break;
            case 17: return "LAST"; break;
         }
      }

      function cancelReorder() {
         global_rpc_data = "";
         update();
      }

      function startReorder() {
         var moved = false;
         document.getElementById("cancelReorder").style.display = "inline";

         //close all the sub directories
         subDirArray = new Array();
         var allSubDirTables = document.getElementsByClassName("mnobordertable");

         Array.prototype.forEach.call(allSubDirTables, function (element) {
            element.style.display = "none";
         });

         var dragSrc = null;
         var dragPreview = null;

         var allDirCheckboxs = document.getElementsByClassName("sub_dir_checkbox");
         var allKeyCheckboxs = document.getElementsByClassName("key_row_checkbox");

         var movingDirs = new Array();
         var movingDirsIndices = new Array();

         var movingKeys = new Array();
         var movingKeysIndices = new Array();

         var reorderButton = document.getElementById("reorder");

         reorderButton.innerText = "done";

         function addListeners(ele) {


            function handleDragStart(e) {
               this.style.opacity=0.4;
               dragSrc = this;
               e.dataTransfer.effectAllowed = 'move';
               e.dataTransfer.setData('text/html', this.innerHTML);
            }

            function handleDragOver(e) {
               if (e.preventDefault) {
                  e.preventDefault();
               }

               e.dataTransfer.dropEffect = 'move';

               return false;
            }

            function handleDragEnter(e) {
               this.classList.add('mmoveitem');
            }

            function handleDragLeave(e) {
               this.classList.remove('mmoveitem');
            }

            function handleDrop(e) {

               if (e.stopPropagation) {
                  e.stopPropagation();
               }

               Array.prototype.forEach.call(allDirCheckboxs, function (element) {
                  element.parentNode.parentNode.classList.remove('mmoveitem');
                  element.parentNode.parentNode.style.opacity=1;
               });

               Array.prototype.forEach.call(allKeyCheckboxs, function (element) {
                  element.parentNode.parentNode.classList.remove('mmoveitem');
                  element.parentNode.parentNode.style.opacity=1;
               });

               if(allDirCheckboxs.length>0)
               document.getElementById("emptyDir").classList.remove('mmoveitem');

               if(allKeyCheckboxs.length>0)
               document.getElementById("emptyKey").classList.remove('mmoveitem');

               if (dragSrc != this && dragSrc.className == this.className) {
                  moved = true;
                  var htmlData = e.dataTransfer.getData('text/html');
                  var newrow = document.createElement("tr");

                  this.parentNode.insertBefore(newrow, this)
                  newrow.innerHTML = htmlData;
                  newrow.id = dragSrc.id;
                  newrow.draggable = dragSrc.draggable;
                  newrow.className = dragSrc.className;
                  this.parentNode.removeChild(dragSrc);

                  addEventListeners(newrow);
               }

               return false;
            }

            function handleDragEnd(e) {
               ele.style.opacity = 1;
               e.dataTransfer.clearData();
            }

            function addEventListeners(ele) {
               ele.addEventListener('dragstart', handleDragStart, false);
               ele.addEventListener('dragenter', handleDragEnter, false);
               ele.addEventListener('dragover', handleDragOver, false);
               ele.addEventListener('dragleave', handleDragLeave, false);
               ele.addEventListener('drop', handleDrop, false);
               ele.addEventListener('dragend', handleDragEnd, false);
            }

            addEventListeners(ele);

         }


         Array.prototype.forEach.call(allDirCheckboxs, function (element) {
            var dragSymbol = document.createElement("span");
            dragSymbol.className = "mdragsymbol";
            element.parentNode.insertBefore(dragSymbol, element);
            element.parentNode.parentNode.draggable = true;
            addListeners(element.parentNode.parentNode);
         });

         if (allDirCheckboxs.length > 0) {
            var lastDir = allDirCheckboxs[allDirCheckboxs.length - 1];
            lastDir = lastDir.parentNode.parentNode;
            var emptyDir = document.createElement("tr");
            emptyDir.id = "emptyDir";

            var emptyTd = document.createElement("td");
            emptyTd.colSpan = "3";
            emptyTd.innerHTML = "&#8203;"
            emptyDir.appendChild(emptyTd);
            lastDir.parentNode.insertBefore(emptyDir, lastDir.nextSibling);
            addListeners(emptyDir);
         }

         Array.prototype.forEach.call(allKeyCheckboxs, function (element) {
            var dragSymbol = document.createElement("span");
            dragSymbol.className = "mdragsymbol";
            element.parentNode.insertBefore(dragSymbol, element);
            element.parentNode.parentNode.draggable = true;
            addListeners(element.parentNode.parentNode);
         });

         if (allKeyCheckboxs.length > 0) {
            var lastKey = allKeyCheckboxs[allKeyCheckboxs.length - 1];
            lastKey = lastKey.parentNode.parentNode;
            var emptyKey = document.createElement("tr");
            emptyKey.id = "emptyKey";
            emptyKey.className = "mODBtr";

            var emptyTd = document.createElement("td");
            emptyTd.colSpan = "3";
            emptyTd.innerHTML = "&#8203;"
            emptyKey.appendChild(emptyTd);
            lastKey.parentNode.insertBefore(emptyKey, lastKey.nextSibling);
            addListeners(emptyKey);
         }

         reorderButton.onclick = function () {
            if (moved) {

               var indexTemp1 = 0;
               Array.prototype.forEach.call(allDirCheckboxs, function (element) {
                  movingDirs.push(custompath + "/" + element.id);
                  movingDirsIndices.push(indexTemp1);
                  indexTemp1++;
               });

               var indexTemp2 = 0;
               Array.prototype.forEach.call(allKeyCheckboxs, function (element) {
                  movingKeys.push(custompath + "/" + element.id);
                  movingKeysIndices.push(indexTemp2);
                  indexTemp2++;
               });


               //               mjsonrpc_call("db_reorder", { "paths":movingDirs, "indices":movingDirsIndices})

               mjsonrpc_send_request([mjsonrpc_make_request("db_reorder", { "paths": movingDirs, "indices": movingDirsIndices }),
               mjsonrpc_make_request("db_reorder", { "paths": movingKeys, "indices": movingKeysIndices })]).then(function (rpc) {
                  console.log(rpc);
                  global_rpc_data = "";
                  update();
               }).catch(function (error) {
                  mjsonrpc_error_alert(error);
               });

            } else {
               global_rpc_data = "";
               update();
            }


         }
      }

      function generateActionBar() {
         var allDirCheckboxs = document.getElementsByClassName("sub_dir_checkbox");
         var allKeyCheckboxs = document.getElementsByClassName("key_row_checkbox");

         var allKeys = new Array();
         var keys = new Array();
         var dirs = new Array();

         Array.prototype.forEach.call(allDirCheckboxs, function (element) {
            if (element.checked) {
               allKeys.push(element.id);
               dirs.push(element.id);
               isKey = false;
            }
         });

         Array.prototype.forEach.call(allKeyCheckboxs, function (element) {
            if (element.checked) {
               allKeys.push(element.id);
               keys.push(element.id);
               isKey = true;
            }
         });
         if (allKeys.length == 0) {
            document.getElementById("mactionBar").style.visibility = "hidden";
            document.getElementById("copy").style.visibility = "hidden";
            document.getElementById("rename").style.visibility = "hidden";
            document.getElementById("resize").style.visibility = "hidden";
            document.getElementById("mode").style.visibility = "hidden";
            document.getElementById("delete").style.visibility = "hidden";
         } else if (keys.length > 1 && dirs.length == 0) {
            document.getElementById("mactionBar").style.visibility = "visible";
            document.getElementById("copy").style.visibility = "hidden";
            document.getElementById("rename").style.visibility = "hidden";
            document.getElementById("resize").style.visibility = "visible";
            document.getElementById("mode").style.visibility = "visible";
            document.getElementById("delete").style.visibility = "visible";
         } else if ((allKeys.length == 1 && keys.length == 1) || (allKeys.length >= 1 && dirs.length == 0)) {
            document.getElementById("mactionBar").style.visibility = "visible";
            document.getElementById("copy").style.visibility = "visible";
            document.getElementById("rename").style.visibility = "visible";
            document.getElementById("resize").style.visibility = "visible";
            document.getElementById("mode").style.visibility = "visible";
            document.getElementById("delete").style.visibility = "visible";
         } else if (keys.length == 0 && dirs.length == 1) {
            document.getElementById("mactionBar").style.visibility = "visible";
            document.getElementById("copy").style.visibility = "visible";
            document.getElementById("rename").style.visibility = "visible";
            document.getElementById("resize").style.visibility = "hidden";
            document.getElementById("mode").style.visibility = "hidden";
            document.getElementById("delete").style.visibility = "visible";
         } else {
            document.getElementById("mactionBar").style.visibility = "visible";
            document.getElementById("copy").style.visibility = "hidden";
            document.getElementById("rename").style.visibility = "hidden";
            document.getElementById("resize").style.visibility = "hidden";
            document.getElementById("mode").style.visibility = "hidden";
            document.getElementById("delete").style.visibility = "visible";
         }
         if (keys.length > 0) {
            document.getElementById("copy").style.visibility = "hidden";
         }
      }

      function create_page_handle_copy(allDirs, isCopy) {

         var allDirs = allDirs.map(function (ele) { return custompath + "/" + ele; })
         var size = "";

         var e = document.getElementById("odbpath");
         path = JSON.parse(e.innerHTML);
         if (path == "/") path = "";

         var targetODB = document.getElementById("copy_name").value;

         mjsonrpc_db_copy(allDirs).then(function (rpc) {
            var status = rpc.result.status[0];
            if (status != 1) {
               alert(JSON.stringify(rpc));
               alert("db_copy() error " + status + ", see MIDAS messages.");
            } else {
               mjsonrpc_db_paste([targetODB], rpc.result.data).then(function (rpc2) {
                  var status2 = rpc2.result.status[0];
                  if (status2 != 1) {
                     alert(JSON.stringify(rpc2));
                     alert("db_paste() error " + status + ", see MIDAS messages.");
                  } else {
                     if (!isCopy) {
                        mjsonrpc_db_delete(allDirs).then(function (rpc3) {
                           var status3 = rpc3.result.status[0];
                           if (status3 != 1) {
                              alert(JSON.stringify(rpc3));
                              alert("db_delete() error " + status + ", see MIDAS messages.");
                           } else {
                              alert("Move success!");
                              dlgCreate.innerHTML = ""; dlgCreate.style.display = "none";
                              update();
                           }
                        });
                     } else {
                        alert("Copy success!");
                        dlgCreate.innerHTML = ""; dlgCreate.style.display = "none";
                        update();
                     }
                  }
               })
            }
         }).catch(function (error) {
            mjsonrpc_error_alert(error);
            update();
         });

         return false;
      }



      function generateCopyDlg() {
         if (document.getElementById("copyTitle") == null) {
            document.getElementById("dlgCreate").innerHTML = "";
            var allSubDirCheckboxs = document.getElementsByClassName("sub_dir_checkbox");

            var allDirs = new Array();


            Array.prototype.forEach.call(allSubDirCheckboxs, function (element) {
               if (element.checked)
                  allDirs.push(element.id);
            });

            if (allDirs.length == 0 || allDirs.length > 1) {
               alert("please select one directory to copy/move");
               return;
            }

            var allDirsStr = allDirs.map(function (ele) { return ele + "\n" });

            document.getElementById("dlgCreate").innerHTML = "";
            var dlgTitlebar = document.createElement("div");
            dlgTitlebar.id = "copyTitle";
            dlgTitlebar.className = "dlgTitlebar";
            dlgTitlebar.innerText = "Copy/Move ODB tree";

            var dlgPanel = document.createElement("div");
            dlgPanel.className = "dlgPanel";

            var odbPath = document.createElement("div");
            odbPath.id = "odbpath";
            if (custompath == "") {
               odbPath.innerText = "\"/\"";
            } else {
               odbPath.innerText = "\"" + custompath + "\"";
            }


            var dlgTable = document.createElement("table");
            dlgTable.className = "mmaintable";

            for (var str in allDirsStr) {

               var oneKeyRow = document.createElement("tr");
               var dirTitle = document.createElement("td");
               var dirName = document.createElement("td");
               dirTitle.innerHTML = "Directory:"
               dirName.innerHTML = allDirsStr[str];
               oneKeyRow.appendChild(dirTitle);
               oneKeyRow.appendChild(dirName);
               dlgTable.appendChild(oneKeyRow);


            }
            dlgTable.innerHTML += "<tr><td>Copy/Move to:</td><td><input type=\"text\" size=\"31\" id=\"copy_name\" name=\"value\" placeholder=\"Target Directory\"></td></tr>";


            var createButton = document.createElement("input");
            createButton.type = "button";
            createButton.className = "mbutton";
            createButton.value = "Copy";
            createButton.onclick = function () { create_page_handle_copy(allDirs, true) };

            var createButton2 = document.createElement("input");
            createButton2.type = "button";
            createButton2.className = "mbutton";
            createButton2.value = "Move";
            createButton2.onclick = function () { create_page_handle_copy(allDirs, false) };

            var cancelButton = document.createElement("input");
            cancelButton.type = "button";
            cancelButton.className = "mbutton";
            cancelButton.value = "Cancel";
            cancelButton.onclick = function () { dlgCreate.innerHTML = ""; dlgCreate.style.display = "none"; };



            dlgPanel.appendChild(odbPath);
            dlgPanel.appendChild(dlgTable);
            dlgPanel.appendChild(createButton);
            dlgPanel.appendChild(createButton2);
            dlgPanel.appendChild(cancelButton);

            document.getElementById("dlgCreate").appendChild(dlgTitlebar);
            document.getElementById("dlgCreate").appendChild(dlgPanel);


         }
         dlgShow('dlgCreate');
      }



      function create_page_handle_rename(theKey) {
         var odbpath = document.getElementById("odbpath");
         odbpath = JSON.parse(odbpath.innerHTML);
         if (odbpath == "/") odbpath = "";

         var path = odbpath + "/" + theKey;
         var name = "";

         if (path == "/") path = "";

         var name = document.getElementById("rename_name").value;

         if (name.length < 1) {
            alert("Name is too short");
            return false;
         }
         mjsonrpc_call("db_rename", { "paths": [path], "new_names": [name] }).then(function (rpc) {
            var status = rpc.result.status[0];
            if (status != 1) {
               alert(JSON.stringify(rpc));
               alert("db_resize() error " + status + ", see MIDAS messages.");
            } else {
               update();
            }
         }).catch(function (error) {
            mjsonrpc_error_alert(error);
            update();
         });

         return false;
      }

      function generateRenameDlg() {
         if (document.getElementById("renameTitle") == null) {
            document.getElementById("dlgCreate").innerHTML = "";
            var isKey = true;
            var allDirCheckboxs = document.getElementsByClassName("sub_dir_checkbox");
            var allKeyCheckboxs = document.getElementsByClassName("key_row_checkbox");

            var allKeys = new Array();

            Array.prototype.forEach.call(allDirCheckboxs, function (element) {
               if (element.checked) {
                  allKeys.push(element.id);
                  isKey = false;
               }
            });

            Array.prototype.forEach.call(allKeyCheckboxs, function (element) {
               if (element.checked) {
                  allKeys.push(element.id);
                  isKey = true;
               }
            });

            if (allKeys.length != 1) {
               alert("please select one key or directory to rename");
               return;
            }

            var theKey = allKeys[0];

            document.getElementById("dlgCreate").innerHTML = "";
            var dlgTitlebar = document.createElement("div");
            dlgTitlebar.id = "renameTitle";
            dlgTitlebar.className = "dlgTitlebar";
            dlgTitlebar.innerText = "Rename ODB entry";

            var dlgPanel = document.createElement("div");
            dlgPanel.className = "dlgPanel";

            var odbPath = document.createElement("div");
            odbPath.id = "odbpath";
            if (custompath == "") {
               odbPath.innerText = "\"/\"";
            } else {
               odbPath.innerText = "\"" + custompath + "\"";
            }


            var dlgTable = document.createElement("table");
            dlgTable.className = "mmaintable";

            var oneKeyRow = document.createElement("tr");
            var keyType = document.createElement("td");
            var keyName = document.createElement("td");
            if (isKey) {
               keyType.innerHTML = "Old name:";
            } else {
               keyType.innerHTML = "Directory:";
            }
            keyName.innerHTML = theKey;
            oneKeyRow.appendChild(keyType);
            oneKeyRow.appendChild(keyName);
            dlgTable.appendChild(oneKeyRow);


            dlgTable.innerHTML += "<tr><td>Rename To</td><td><input type=\"text\" size=\"20\" id=\"rename_name\" name=\"value\"></td></tr>";


            var createButton = document.createElement("input");
            createButton.type = "button";
            createButton.className = "mbutton";
            createButton.value = "Rename";
            createButton.onclick = function () { create_page_handle_rename(theKey) };

            var cancelButton = document.createElement("input");
            cancelButton.type = "button";
            cancelButton.className = "mbutton";
            cancelButton.value = "Cancel";
            cancelButton.onclick = function () { dlgCreate.innerHTML = ""; dlgCreate.style.display = "none"; };



            dlgPanel.appendChild(odbPath);
            dlgPanel.appendChild(dlgTable);
            dlgPanel.appendChild(createButton);
            dlgPanel.appendChild(cancelButton);

            document.getElementById("dlgCreate").appendChild(dlgTitlebar);
            document.getElementById("dlgCreate").appendChild(dlgPanel);


         }
         dlgShow('dlgCreate');
      }

      function create_page_handle_access_mode(allKeys) {

         var allKeys = allKeys.map(function (ele) { return custompath + "/" + ele; })
         var size = "";

         var e = document.getElementById("odbpath");
         path = JSON.parse(e.innerHTML);
         if (path == "/") path = "";

         var size = document.getElementById("resize_name").value;
         sizeArray = new Array();
         for (var i = 0; i < allKeys.length; i++) {
            sizeArray.push(size);
         }

         if (path == "/") path = "";

         if (size.length < 1 || size == 0) {
            alert("Size must be larger than 0");
            return false;
         }
         mjsonrpc_db_resize(allKeys, sizeArray).then(function (rpc) {
            var status = rpc.result.status[0];
            if (status != 1) {
               alert(JSON.stringify(rpc));
               alert("db_resize() error " + status + ", see MIDAS messages.");
            } else {
               update();
            }
         }).catch(function (error) {
            mjsonrpc_error_alert(error);
            update();
         });

         return false;
      }



      function generateAccessModeDlg() {
         if (document.getElementById("modeTitle") == null) {
            document.getElementById("dlgCreate").innerHTML = "";
            var allKeyCheckboxs = document.getElementsByClassName("key_row_checkbox");

            var allKeys = new Array();

            Array.prototype.forEach.call(allKeyCheckboxs, function (element) {
               if (element.checked)
                  allKeys.push(element.id);
            });

            if (allKeys.length == 0) {
               alert("please select at least one key to change access mode");
               return;
            }

            var allKeysStr = allKeys.map(function (ele) { return ele + "\n" });


            document.getElementById("dlgCreate").innerHTML = "";
            var dlgTitlebar = document.createElement("div");
            dlgTitlebar.id = "modeTitle";
            dlgTitlebar.className = "dlgTitlebar";
            dlgTitlebar.innerText = "Change ODB entry access mode";

            var dlgPanel = document.createElement("div");
            dlgPanel.className = "dlgPanel";

            var odbPath = document.createElement("div");
            odbPath.id = "odbpath";
            if (custompath == "") {
               odbPath.innerText = "\"/\"";
            } else {
               odbPath.innerText = "\"" + custompath + "\"";
            }


            var dlgTable = document.createElement("table");
            dlgTable.className = "mmaintable";

            dlgTable.innerHTML = "<tr><th>key name</th><th>mode</th></tr>"

            for (var str in allKeysStr) {
               var key_row = document.getElementById(allKeys[str] + "key_row");
               if (key_row != null) {
                  var oneKeyRow = document.createElement("tr");
                  var keyType = document.createElement("td");
                  var keyName = document.createElement("td");
                  keyType.innerHTML = allKeysStr[str];
                  keyName.innerHTML = key_row.childNodes[7].innerHTML;
                  oneKeyRow.appendChild(keyType);
                  oneKeyRow.appendChild(keyName);
                  dlgTable.appendChild(oneKeyRow);
               }

            }
            dlgTable.innerHTML += "<tr><td>Change Mode To</td><td><input type=\"number\" size=\"31\" maxlength=\"31\" id=\"resize_name\" name=\"value\"></td></tr>";


            var createButton = document.createElement("input");
            createButton.type = "button";
            createButton.className = "mbutton";
            createButton.value = "Change Mode";
            createButton.onclick = function () { create_page_handle_access_mode(allKeys) };

            var cancelButton = document.createElement("input");
            cancelButton.type = "button";
            cancelButton.className = "mbutton";
            cancelButton.value = "Cancel";
            cancelButton.onclick = function () { dlgCreate.innerHTML = ""; dlgCreate.style.display = "none"; };



            dlgPanel.appendChild(odbPath);
            dlgPanel.appendChild(dlgTable);
            dlgPanel.appendChild(createButton);
            dlgPanel.appendChild(cancelButton);

            document.getElementById("dlgCreate").appendChild(dlgTitlebar);
            document.getElementById("dlgCreate").appendChild(dlgPanel);


         }
         dlgShow('dlgCreate');
      }


      function create_page_handle_resize(allKeys) {

         var allKeys = allKeys.map(function (ele) { return custompath + "/" + ele; })
         var size = "";

         var e = document.getElementById("odbpath");
         path = JSON.parse(e.innerHTML);
         if (path == "/") path = "";

         var size = document.getElementById("resize_name").value;
         sizeArray = new Array();
         for (var i = 0; i < allKeys.length; i++) {
            sizeArray.push(size);
         }

         if (path == "/") path = "";

         if (size.length < 1 || size == 0) {
            alert("Size must be larger than 0");
            return false;
         }
         mjsonrpc_db_resize(allKeys, sizeArray).then(function (rpc) {
            var status = rpc.result.status[0];
            if (status != 1) {
               alert(JSON.stringify(rpc));
               alert("db_resize() error " + status + ", see MIDAS messages.");
            } else {
               update();
            }
         }).catch(function (error) {
            mjsonrpc_error_alert(error);
            update();
         });

         return false;
      }



      function generateResizeDlg() {
         if (document.getElementById("resizeTitle") == null) {
            document.getElementById("dlgCreate").innerHTML = "";
            var allKeyCheckboxs = document.getElementsByClassName("key_row_checkbox");

            var allKeys = new Array();

            Array.prototype.forEach.call(allKeyCheckboxs, function (element) {
               if (element.checked)
                  allKeys.push(element.id);
            });

            if (allKeys.length == 0) {
               alert("please select at least one key to resize");
               return;
            }

            var allKeysStr = allKeys.map(function (ele) { return ele + "\n" });


            document.getElementById("dlgCreate").innerHTML = "";
            var dlgTitlebar = document.createElement("div");
            dlgTitlebar.id = "resizeTitle";
            dlgTitlebar.className = "dlgTitlebar";
            dlgTitlebar.innerText = "Resize ODB entry";

            var dlgPanel = document.createElement("div");
            dlgPanel.className = "dlgPanel";

            var odbPath = document.createElement("div");
            odbPath.id = "odbpath";
            if (custompath == "") {
               odbPath.innerText = "\"/\"";
            } else {
               odbPath.innerText = "\"" + custompath + "\"";
            }


            var dlgTable = document.createElement("table");
            dlgTable.className = "mmaintable";

            dlgTable.innerHTML = "<tr><th>key name</th><th>size</th></tr>"

            for (var str in allKeysStr) {
               var key_row = document.getElementById(allKeys[str] + "key_row");
               if (key_row != null) {
                  var oneKeyRow = document.createElement("tr");
                  var keyType = document.createElement("td");
                  var keyName = document.createElement("td");
                  keyType.innerHTML = allKeysStr[str];
                  keyName.innerHTML = key_row.childNodes[5].innerHTML;
                  oneKeyRow.appendChild(keyType);
                  oneKeyRow.appendChild(keyName);
                  dlgTable.appendChild(oneKeyRow);
               }

            }
            dlgTable.innerHTML += "<tr><td>Change Size To</td><td><input type=\"number\" size=\"31\" maxlength=\"31\" id=\"resize_name\" name=\"value\"></td></tr>";


            var createButton = document.createElement("input");
            createButton.type = "button";
            createButton.className = "mbutton";
            createButton.value = "Resize";
            createButton.onclick = function () { create_page_handle_resize(allKeys) };

            var cancelButton = document.createElement("input");
            cancelButton.type = "button";
            cancelButton.className = "mbutton";
            cancelButton.value = "Cancel";
            cancelButton.onclick = function () { dlgCreate.innerHTML = ""; dlgCreate.style.display = "none"; };



            dlgPanel.appendChild(odbPath);
            dlgPanel.appendChild(dlgTable);
            dlgPanel.appendChild(createButton);
            dlgPanel.appendChild(cancelButton);

            document.getElementById("dlgCreate").appendChild(dlgTitlebar);
            document.getElementById("dlgCreate").appendChild(dlgPanel);


         }
         dlgShow('dlgCreate');
      }




      function create_page_handle_create() {
         var path = "";
         var type = "";
         var name = "";
         var arraylength = "";
         var stringlength = "";

         var form = document.getElementsByTagName('form')[0];

         if (form) {
            path = form.elements['odb'].value;
            type = form.elements['type'].value;
            name = form.elements['value'].value;
            arraylength = form.elements['index'].value;
            stringlength = form.elements['strlen'].value;
         } else {
            var e = document.getElementById("odbpath");
            path = JSON.parse(e.innerHTML);
            if (path == "/") path = "";

            type = document.getElementById("create_tid").value;
            name = document.getElementById("create_name").value;
            arraylength = document.getElementById("create_array_length").value;
            stringlength = document.getElementById("create_strlen").value;

            //alert("Path: " + path + " Name: " + name);
         }

         if (path == "/") path = "";

         if (name.length < 1) {
            alert("Name is too short");
            return false;
         }

         var int_array_length = parseInt(arraylength);

         //alert("int_array_length: " + int_array_length);

         if (!int_array_length || int_array_length < 1) {
            alert("Bad array length: " + arraylength);
            return false;
         }

         var int_string_length = parseInt(stringlength);

         if (!int_string_length || int_string_length < 1) {
            alert("Bad string length " + stringlength);
            return false;
         }

         var param = {};
         param.path = path + "/" + name;
         param.type = parseInt(type);
         if (int_array_length > 1)
            param.array_length = int_array_length;
         if (int_string_length > 0)
            param.string_length = int_string_length;

         mjsonrpc_db_create([param]).then(function (rpc) {
            var status = rpc.result.status[0];
            if (status == 311) {
               alert("ODB entry with this name already exists.");
            } else if (status != 1) {
               alert("db_create_key() error " + status + ", see MIDAS messages.");
            } else {
               update();
            }
         }).catch(function (error) {
            mjsonrpc_error_alert(error);
            update();
         });

         return false;
      }


      function generateCreateDlg() {
         if (document.getElementById("createTitle") == null) {
            document.getElementById("dlgCreate").innerHTML = "";
            var dlgTitlebar = document.createElement("div");
            dlgTitlebar.id = "createTitle";
            dlgTitlebar.className = "dlgTitlebar";
            dlgTitlebar.innerText = "Create ODB entry";

            var dlgPanel = document.createElement("div");
            dlgPanel.className = "dlgPanel";

            var odbPath = document.createElement("div");
            odbPath.id = "odbpath";
            if (custompath == "") {
               odbPath.innerText = "\"/\"";
            } else {
               odbPath.innerText = "\"" + custompath + "\"";
            }


            var dlgTable = document.createElement("table");
            dlgTable.className = "mmaintable";
            dlgTable.innerHTML = "<tr><th colspan=\"2\">Create ODB entry:</th>\n</tr><tr><td>Type</td><td><select type=\"text\" size=\"1\" id=\"create_tid\" name=\"type\"><option value=\"7\">Integer (32-bit)</option><option value=\"9\">Float (4 Bytes)</option><option value=\"12\">String</option><option selected=\"\" value=\"15\">Subdirectory</option><option value=\"1\">Byte</option><option value=\"2\">Signed byte</option><option value=\"3\">Character (8-bit)</option><option value=\"4\">Word (16-bit)</option><option value=\"5\">Short integer(16-bit)</option><option value=\"6\">Double Word (32-bit)</option><option value=\"8\">Boolean</option><option value=\"10\">Double float(8 Bytes)</option><option value=\"16\">Symbolic link</option></select></td></tr>\n<tr><td>Name</td><td><input type=\"text\" size=\"31\" maxlength=\"31\" id=\"create_name\" name=\"value\"></td></tr>\n<tr><td>Array size</td><td><input type=\"text\" size=\"31\" maxlength=\"31\" id=\"create_array_length\" name=\"index\" value=\"1\"></td></tr>\n<tr><td>String length</td><td><input type=\"text\" size=\"31\" maxlength=\"31\" id=\"create_strlen\" name=\"strlen\" value=\"32\"></td></tr>"




            var createButton = document.createElement("input");
            createButton.type = "button";
            createButton.className = "mbutton";
            createButton.value = "Create";
            createButton.onclick = function () { create_page_handle_create() };

            var cancelButton = document.createElement("input");
            cancelButton.type = "button";
            cancelButton.className = "mbutton";
            cancelButton.value = "Cancel";
            cancelButton.onclick = function () { dlgCreate.innerHTML = ""; dlgCreate.style.display = "none"; };



            dlgPanel.appendChild(odbPath);
            dlgPanel.appendChild(dlgTable);
            dlgPanel.appendChild(createButton);
            dlgPanel.appendChild(cancelButton);

            document.getElementById("dlgCreate").appendChild(dlgTitlebar);
            document.getElementById("dlgCreate").appendChild(dlgPanel);


         }
         dlgShow('dlgCreate');
      }



      function deleteDirsAndKeys() {
         var allDirCheckboxs = document.getElementsByClassName("sub_dir_checkbox");
         var allKeyCheckboxs = document.getElementsByClassName("key_row_checkbox");
         var allDeleteDirs = new Array();
         var allDeleteKeys = new Array();
         Array.prototype.forEach.call(allDirCheckboxs, function (element) {
            if (element.checked)
               allDeleteDirs.push(element.id);
         });
         Array.prototype.forEach.call(allKeyCheckboxs, function (element) {
            if (element.checked)
               allDeleteKeys.push(element.id);
         });
         if (allDeleteDirs.length == 0 && allDeleteKeys.length == 0) {
            alert("please select at least one directory or key to delete");
            return;
         }
         var allDeleteDirsStr = allDeleteDirs.map(function (ele) { return ele + "\n" });
         var allDeleteKeysStr = allDeleteKeys.map(function (ele) { return ele + "\n" });
         allDeleteDirsStr = allDeleteDirsStr.join("");
         allDeleteKeysStr = allDeleteKeysStr.join("");


         if (allDeleteDirsStr.length > 0 && allDeleteKeysStr.length > 0) {
            var confirmStr = "You are trying to delete\n\n(DIRECTORIES)\n" + allDeleteDirsStr + "\n(KEYS)\n" + allDeleteKeysStr + "\nAre you sure?";
         } else if (allDeleteDirsStr.length > 0) {
            var confirmStr = "You are trying to delete\n\n(DIRECTORIES)\n" + allDeleteDirsStr + "\nAre you sure?";
         } else if (allDeleteKeysStr.length > 0) {
            var confirmStr = "You are trying to delete\n\n(KEYS)\n" + allDeleteKeysStr + "\nAre you sure?";
         }
         if (confirm(confirmStr)) {
            var path = new Array();
            Array.prototype.forEach.call(allDirCheckboxs, function (element) {
               if (element.checked)
                  path.push(custompath + "/" + element.id);
            });
            Array.prototype.forEach.call(allKeyCheckboxs, function (element) {
               if (element.checked)
                  path.push(custompath + "/" + element.id);
            });
            mjsonrpc_db_delete(path).then(function (rpc) {
               update();
            }).catch(function (error) {
               mjsonrpc_error_alert(error);
            });
         }
      }



      function callback(rpc, currentDir) {


         var ODBTable = document.getElementById("ODBTable");
         var obj = rpc.result.data[0];
         if (rpc.result.data.length > 1) {
            var subDirObj = rpc.result.data.slice(1);
            //alert(JSON.stringify(subDirObj));
         } else {
            var subDirObj = null;
         }


         function updateSubDir() {
            if (subDirArray.length > 0) {
               if (global_rpc_subDir != null && JSON.stringify(global_rpc_subDir) != JSON.stringify(subDirObj)) {
                  subDirArray.forEach(function (ele) {
                     var tables = document.getElementsByTagName("table");
                     Array.prototype.forEach.call(tables, function (table) {
                        if (table.id == ele)
                           if (table != null || table != undefined) {
                              generateSubDir(ele, null, table);
                           }
                     });

                  });
               }
            }
            global_rpc_subDir = subDirObj;
         }

         function generateSubDir(path, rowElement, replaceTable) {

            var result;

            mjsonrpc_db_ls([path]).then(function (rpc) {

               function generateSub_Dir_Sub_Dir() {

                  if (sub_dir_sub_dir.length > 0) {
                     sub_dir_sub_dir.forEach(function (element) {

                        function expand() {
                           subDirArray.push(sub_dir_expand_link.id);
                           sub_dir_expand_link.innerHTML = "&#9660;";
                           sub_dir_expand_link.removeEventListener('click', expand);
                           sub_dir_expand_link.addEventListener('click', fold);
                           if (document.getElementById(sub_dir_expand_link.id + "sub_dir") == undefined) {
                              generateSubDir(sub_dir_expand_link.id, sub_dir_row);
                           } else {
                              document.getElementById(sub_dir_expand_link.id + "sub_dir").style.display = "table-row";
                           }
                        }

                        function fold() {
                           var index = subDirArray.indexOf(sub_dir_expand_link.id);
                           if (index >= 0) {
                              subDirArray.splice(index, 1);
                           }
                           sub_dir_expand_link.innerHTML = "&#9654;";
                           sub_dir_expand_link.removeEventListener('click', fold);
                           sub_dir_expand_link.addEventListener('click', expand);
                           document.getElementById(sub_dir_expand_link.id + "sub_dir").style.display = "none";
                        }

                        function highlight() {
                           sub_dir_expand_link.style.color = "#00CC00";
                        }

                        function unhighlight() {
                           sub_dir_expand_link.style.color = "#000000";
                        }


                        var sub_dir_row = document.createElement("tr");
                        sub_dir_row.id = subDirTable.id + "/" + element + "sub_dir_row";
                        var sub_dir_col = document.createElement("td");
                        var sub_dir_expand_link = document.createElement("span");
                        var sub_dir_link = document.createElement("span");


                        sub_dir_link.innerHTML = " " + element;
                        sub_dir_link.href = "#";
                        sub_dir_link.onclick = "return false;";
                        if (element.charAt(0) != "/" && custompath.slice(-1) != "/") {
                           sub_dir_link.addEventListener('click', function () { window.location.href = global_base_url + "odb.html?odbpath=" + subDirTable.id + "/" + element; });
                        } else {
                           sub_dir_link.addEventListener('click', function () { window.location.href = global_base_url + "odb.html?odbpath=" + subDirTable.id + element; });
                        }
                        sub_dir_link.className = "modblink";
                        sub_dir_expand_link.innerHTML = "&#9654;";
                        sub_dir_expand_link.className = "modbarrow";
                        sub_dir_expand_link.href = "#";
                        sub_dir_expand_link.onclick = "return false;";
                        sub_dir_expand_link.id = subDirTable.id + "/" + element;
                        sub_dir_expand_link.addEventListener('click', expand);
                        sub_dir_expand_link.addEventListener('mouseover', highlight);
                        sub_dir_expand_link.addEventListener('mouseout', unhighlight);

                        sub_dir_col.appendChild(sub_dir_expand_link);
                        sub_dir_col.appendChild(sub_dir_link);

                        sub_dir_col.colSpan = "3";

                        sub_dir_row.appendChild(sub_dir_col);

                        subDirTable.appendChild(sub_dir_row);


                     });
                  }
               }

               function generateSub_Dir_Keys() {
                  if (sub_dir_odb_keys.length > 0) {
                     key_row_div.id = "keyItems";

                     var key_title_row = document.createElement("tr");
                     key_title_row.className = "mODBtr";


                     var key_title = document.createElement("th");
                     key_title.innerHTML = "Key";

                     var value_title = document.createElement("th");
                     value_title.innerHTML = "Value";

                     key_title_row.appendChild(key_title);
                     key_title_row.appendChild(value_title);

                     key_row_div.appendChild(key_title_row);

                     sub_dir_odb_keys.forEach(function (element) {
                        var key_row = document.createElement("tr");
                        key_row.className = "mODBtr";

                        var key_row_key = document.createElement("td");
                        key_row_key.innerHTML = element;
                        key_row_key.className = "keyCell";


                        var key_row_value = document.createElement("td");
                        key_row_value.innerHTML = subDirObj[element];
                        key_row_value.id = element;
                        key_row_value.className = "keyCell mkeyCellEditable";


                        key_row.appendChild(key_row_key);
                        key_row.appendChild(key_row_value);


                        key_row_div.appendChild(key_row);
                     });

                     subDirTable.appendChild(key_row_div);
                  }
               }


               var subDirObj = rpc.result.data[0];

               var sub_dir_sub_dir = new Array();
               var sub_dir_odb_keys = new Array();


               //get all keys of the data object
               var keys = Object.keys(subDirObj);

               // for each key...
               keys.forEach(function (key) {
                  // if the value of the key is not an object, then it must be a key with value
                  if (typeof subDirObj[key] !== 'object') {
                     sub_dir_odb_keys.push(key);
                     // if the value of the key is an object and length is 0, then it must be a sub directory
                  } else if (Object.keys(subDirObj[key]).length === 0) {
                     sub_dir_sub_dir.push(key);
                  }
                  // rest of them are key properties
               });



               var spaceNum = path.replace(custompath, "").split("/").length - 1;


               var subDirRow = document.createElement("tr")
               subDirRow.id = path + "sub_dir";
               var subDirSpace = document.createElement("td");
               subDirSpace.colSpan = 1;
               var subDirTd = document.createElement("td");

               var subDirTable = document.createElement("table");
               subDirTable.id = path;
               subDirTable.tagName = path + "sub_dir_table";

               subDirTable.className = "mnobordertable";
               if (sub_dir_sub_dir.length > 0 || sub_dir_odb_keys.length > 0) {
                  var key_row_div = document.createElement("div");
                  generateSub_Dir_Sub_Dir();
                  generateSub_Dir_Keys();
               } else {
                  subDirTable.innerHTML = "(empty)";
               }


               subDirTd.appendChild(subDirTable);

               subDirRow.appendChild(subDirSpace);
               subDirRow.appendChild(subDirTd);
               if (rowElement != null && rowElement != undefined)
                  rowElement.parentNode.insertBefore(subDirRow, rowElement.nextSibling);

               if (replaceTable != null && replaceTable != undefined) {
                  if (replaceTable.lastChild.id == "keyItems") {
                     replaceTable.removeChild(replaceTable.lastChild);
                     replaceTable.appendChild(key_row_div);
                  }
               }
            })

         }


         function generateSub_Dir() {

            function checkAllCheckbox() {
               var allCheckboxs = document.getElementsByClassName("sub_dir_checkbox");
               Array.prototype.forEach.call(allCheckboxs, function (element) {
                  if (element.checked) {
                     element.checked = false;
                     element.style.opacity = 0.4;
                  } else {
                     element.checked = true;
                     element.style.opacity = 1;
                  }
               });
            }


            if (sub_dir.length > 0) {
               sub_dir.forEach(function (element) {


                  function showCheckbox() {
                     sub_dir_checkbox.style.opacity = 1;
                  }

                  function hideCheckbox() {
                     if (!sub_dir_checkbox.checked)
                        sub_dir_checkbox.style.opacity = 0.3;
                  }

                  function expand() {
                     subDirArray.push(sub_dir_expand_link.id);
                     sub_dir_expand_link.innerHTML = "&#9660;";
                     sub_dir_expand_link.removeEventListener('click', expand);
                     sub_dir_expand_link.addEventListener('click', fold);
                     if (document.getElementById(sub_dir_expand_link.id + "sub_dir") == undefined) {
                        generateSubDir(sub_dir_expand_link.id, sub_dir_row);
                     } else {
                        document.getElementById(sub_dir_expand_link.id + "sub_dir").style.display = "table-row";
                     }
                  }

                  function fold() {
                     var index = subDirArray.indexOf(sub_dir_expand_link.id);
                     if (index >= 0) {
                        subDirArray.splice(index, 1);
                     }
                     sub_dir_expand_link.innerHTML = "&#9654;";
                     sub_dir_expand_link.removeEventListener('click', fold);
                     sub_dir_expand_link.addEventListener('click', expand);
                     document.getElementById(sub_dir_expand_link.id + "sub_dir").style.display = "none";
                  }

                  function highlight() {
                     sub_dir_expand_link.style.color = "#00CC00";
                  }

                  function unhighlight() {
                     sub_dir_expand_link.style.color = "#000000";
                  }



                  var sub_dir_row = document.createElement("tr");
                  sub_dir_row.id = "/" + element + "sub_dir_row";

                  var sub_dir_checkbox = document.createElement("input");
                  var sub_dir_col = document.createElement("td");
                  var sub_dir_expand_link = document.createElement("span");
                  var sub_dir_link = document.createElement("span");



                  sub_dir_checkbox.type = "checkbox";
                  sub_dir_checkbox.id = element;
                  sub_dir_checkbox.className = "sub_dir_checkbox";
                  sub_dir_checkbox.style.opacity = 0.3;
                  sub_dir_checkbox.addEventListener('mouseover', showCheckbox);
                  sub_dir_checkbox.addEventListener('mouseout', hideCheckbox);


                  sub_dir_link.innerHTML = " " + element;
                  sub_dir_link.href = "#";
                  sub_dir_link.onclick = "return false;";
                  if (element.charAt(0) != "/" && custompath.slice(-1) != "/") {
                     sub_dir_link.addEventListener('click', function () { window.location.href = global_base_url + "odb.html?odbpath=" + custompath + "/" + element; });
                  } else {
                     sub_dir_link.addEventListener('click', function () { window.location.href = global_base_url + "odb.html?odbpath=" + custompath + element; });
                  }
                  sub_dir_link.className = "modblink";

                  sub_dir_expand_link.innerHTML = "&#9654;";
                  sub_dir_expand_link.className = "modbarrow";
                  sub_dir_expand_link.href = "#";
                  sub_dir_expand_link.onclick = "return false;";
                  sub_dir_expand_link.id = custompath + "/" + element;
                  sub_dir_expand_link.addEventListener('click', expand);
                  sub_dir_expand_link.addEventListener('mouseover', highlight);
                  sub_dir_expand_link.addEventListener('mouseout', unhighlight);

                  sub_dir_col.appendChild(sub_dir_checkbox);
                  sub_dir_col.appendChild(sub_dir_expand_link);
                  sub_dir_col.appendChild(sub_dir_link);

                  sub_dir_col.colSpan = "3";

                  sub_dir_row.appendChild(sub_dir_col);

                  ODBTable.appendChild(sub_dir_row);

               });
               document.getElementById("allSubDirs").style.display = "block";
               document.getElementById("allSubDirs").addEventListener("click", checkAllCheckbox);
            } else {
               document.getElementById("allSubDirs").style.display = "none";
            }
         }

         function generateODB_Keys() {

            function checkAllCheckbox() {
               var allCheckboxs = document.getElementsByClassName("key_row_checkbox");
               Array.prototype.forEach.call(allCheckboxs, function (element) {
                  if (element.checked) {
                     element.checked = false;
                     element.style.opacity = 0.4;
                  } else {
                     element.checked = true;
                     element.style.opacity = 1;
                  }
               });
            }


            function showCheckbox(element) {
               element.style.opacity = 1;
            }

            function hideCheckbox(element) {
               if (!element.checked)
                  element.style.opacity = 0.4;
            }


            function editKey(element) {
               resetEditKey();
               currentEditing = element;
               element.style.display = "none";
               var editableKey = document.createElement("td");
               var input = document.createElement("input");
               input.id = element.id;
               input.lastvalue = element.innerText;
               input.value = element.innerText;
               document.addEventListener("keydown", function (event) {
                  if (event.keyCode == 27) resetEditKey();
                  if (event.keyCode == 13)
                     if (input.value != input.lastvalue) {
                        updatekey(input);
                     } else {
                        resetEditKey();
                     }
               });
               editableKey.appendChild(input);
               if (element.className.indexOf("expandCell") != -1) {
                  editableKey.className = "editableKey expandCell";
               } else {
                  editableKey.className = "editableKey";
               }
               var parent = element.parentNode;
               parent.insertBefore(editableKey, element);
            }

            function resetEditKey() {
               var editingKeyCells = document.getElementsByClassName("editableKey");

               Array.prototype.forEach.call(editingKeyCells, function (ele) {
                  ele.outerHTML = "";
                  delete ele;
               });

               var keyCells = document.getElementsByClassName("keyCell");

               if (currentEditing != null) {
                  if (isExpand || currentEditing.className.indexOf("expandCell") == -1)
                     currentEditing.style.display = "table-cell";
                  currentEditing = null;
               }

            }



            function expandproperty() {
               isExpand = true;

               var hidecells = document.getElementsByClassName("expandCell");

               Array.prototype.forEach.call(hidecells, function (element) {
                  element.style.display = "table-cell";
               });
               exp.removeEventListener('click', expandproperty);
               exp.addEventListener('click', foldproperty);
               exp.innerHTML = "&#8722;";
            }

            function foldproperty() {
               isExpand = false;

               var hidecells = document.getElementsByClassName("expandCell");

               Array.prototype.forEach.call(hidecells, function (element) {
                  element.style.display = "none";
               });
               exp.removeEventListener('click', foldproperty);
               exp.addEventListener('click', expandproperty)
               exp.innerHTML = "&#43;";

            }


            if (odb_keys.length > 0) {
               var key_title_row = document.createElement("tr");
               key_title_row.className = "mODBtr";


               var key_title_checkbox = document.createElement("input");
               key_title_checkbox.type = "checkbox";
               key_title_checkbox.id = "allElements";
               key_title_checkbox.className = "key_selectall";
               var key_title_checkall = document.createElement("th");
               key_title_checkall.appendChild(key_title_checkbox);


               var key_title = document.createElement("th");
               key_title.innerHTML = "Key";

               var value_title = document.createElement("th");
               value_title.innerHTML = "Value";

               var type_title = document.createElement("th");
               type_title.innerHTML = "Type";
               type_title.className = "expandCell";

               var val_title = document.createElement("th");
               val_title.innerHTML = "#Val";
               val_title.className = "expandCell";

               var size_title = document.createElement("th");
               size_title.innerHTML = "Size";
               size_title.className = "expandCell";

               var written_title = document.createElement("th");
               written_title.innerHTML = "Written";
               written_title.className = "expandCell";

               var mode_title = document.createElement("th");
               mode_title.innerHTML = "Mode";
               mode_title.className = "expandCell";

               var expandkey = document.createElement("div");
               expandkey.style.display = "inline";
               expandkey.style.cssFloat = "right";

               value_title.appendChild(expandkey);

               var exp = document.createElement("span");
               exp.className = "modblink";
               exp.id = "exp";
               exp.href = "#";
               exp.onclick = "return false;";
               exp.innerHTML = "&#43;";
               exp.addEventListener('click', expandproperty);

               expandkey.appendChild(exp);

               key_title_row.appendChild(key_title_checkall);
               key_title_row.appendChild(key_title);
               key_title_row.appendChild(value_title);
               key_title_row.appendChild(type_title);
               key_title_row.appendChild(val_title);
               key_title_row.appendChild(size_title);
               key_title_row.appendChild(written_title);
               key_title_row.appendChild(mode_title);

               ODBTable.appendChild(key_title_row);

               odb_keys.forEach(function (element) {
                  var key_row = document.createElement("tr");
                  key_row.id = element + "key_row";
                  key_row.className = "mODBtr";

                  var key_row_checkbox_cell = document.createElement("td");
                  key_row_checkbox_cell.className = "keyCell";
                  var key_row_checkbox = document.createElement("input");
                  key_row_checkbox.type = "checkbox";
                  key_row_checkbox.id = element;
                  key_row_checkbox.className = "key_row_checkbox";
                  key_row_checkbox.style.opacity = 0.4;
                  key_row_checkbox.addEventListener('mouseover', function () { showCheckbox(key_row_checkbox) });
                  key_row_checkbox.addEventListener('mouseout', function () { hideCheckbox(key_row_checkbox) });
                  key_row_checkbox_cell.appendChild(key_row_checkbox);

                  var key_row_key = document.createElement("td");
                  key_row_key.innerHTML = element;
                  key_row_key.className = "keyCell";


                  var key_row_value = document.createElement("td");
                  key_row_value.innerHTML = obj[element];
                  key_row_value.id = element;
                  key_row_value.className = "keyCell mkeyCellEditable";

                  var key_row_type = document.createElement("td");
                  key_row_type.innerHTML = obj[element + "/key"]["type"];
                  key_row_type.className = "expandCell keyCell";


                  key_row_type.innerHTML = getKeyType(obj[element + "/key"]["type"]);


                  var key_row_val = document.createElement("td");
                  key_row_val.innerHTML = obj[element];
                  key_row_val.className = "expandCell keyCell";

                  var key_row_size = document.createElement("td");
                  key_row_size.innerHTML = sizeOfObject(obj[element]);
                  key_row_size.className = "expandCell keyCell";

                  var key_row_written = document.createElement("td");
                  key_row_written.innerHTML = getLastWritten(element);
                  key_row_written.id = element;
                  key_row_written.className = "expandCell keyCell lastWritten";


                  var key_row_mode = document.createElement("td");
                  var access_mode = "";
                  if (obj[element + "/key"]["access_mode"] & MODE_READ) {
                     access_mode += "R";
                  }
                  if (obj[element + "/key"]["access_mode"] & MODE_WRITE) {
                     access_mode += "W";
                  }
                  if (obj[element + "/key"]["access_mode"] & MODE_DELETE) {
                     access_mode += "D";
                  }
                  if (obj[element + "/key"]["access_mode"] & MODE_EXCLUSIVE) {
                     access_mode += "E";
                  }
                  key_row_mode.innerHTML = access_mode;
                  key_row_mode.className = "expandCell keyCell";

                  key_row.appendChild(key_row_checkbox_cell);
                  key_row.appendChild(key_row_key);
                  key_row.appendChild(key_row_value);
                  key_row.appendChild(key_row_type);
                  key_row.appendChild(key_row_val);
                  key_row.appendChild(key_row_size);
                  key_row.appendChild(key_row_written);
                  key_row.appendChild(key_row_mode);

                  ODBTable.appendChild(key_row);
               });

               var hidecells = document.getElementsByClassName("expandCell");

               Array.prototype.forEach.call(hidecells, function (element) {
                  element.style.display = "none";
               });

               var keycells = document.getElementsByClassName("keyCell");

               Array.prototype.forEach.call(keycells, function (element) {
                  element.addEventListener('click', function () { resetEditKey() });
               });

               var keycells = document.getElementsByClassName("mkeyCellEditable");

               Array.prototype.forEach.call(keycells, function (element) {
                  element.addEventListener('click', function () { editKey(element); });
                  element.addEventListener('touchstart', function () { editKey(element); });
               });

               document.getElementById("allElements").addEventListener("click", checkAllCheckbox);

            }
         }

         function getLastWritten(element) {
            var last_written = Math.round(new Date().getTime() / 1000) - obj[element + "/key"]["last_written"];
            if (last_written < 60) {
               return Math.floor(last_written) + "s";
            } else if (last_written < 3600) {
               return Math.floor(last_written / 60) + "m";
            } else if (last_written < 86400) {
               return Math.floor(last_written / 3600) + "h";
            } else if (last_written < 86400 * 99) {
               return Math.floor(last_written / 86400) + "d";
            } else {
               return ">99d";
            }
         }

         function updateLastWritten() {
            var lastWrittenCells = document.getElementsByClassName("lastWritten");

            Array.prototype.forEach.call(lastWrittenCells, function (element) {
               var a = getLastWritten(element.id);
               if (element.innerHTML != getLastWritten(element.id)) {
                  element.innerHTML = getLastWritten(element.id);
               }
            });
         }


         // CALLBACK STARTS HERE


         if (global_dir_data != currentDir || JSON.stringify(global_rpc_data) != JSON.stringify(rpc.result.data[0])) {
            if (ODBTable.innerHTML != ODBTableinnerHTML)
               ODBTable.innerHTML = ODBTableinnerHTML;
            global_dir_data = "";
            global_rpc_data = "";
            subDirArray = new Array();
         }

         // odb directory very rarely changes
         if (global_dir_data != currentDir) {
            global_dir_data = currentDir;
            document.getElementById("currentDir").innerHTML = "";

            dirArray = currentDir.split("/");
            for (var i = 0; i < dirArray.length; i++) {
               if (i == 0) {
                  var currentDirLink = document.createElement("span");
                  currentDirLink.className = "modblink";
                  currentDirLink.innerHTML = "ODB";
                  currentDirLink.href = "#";
                  currentDirLink.onclick = "return false;"
                  currentDirLink.addEventListener('click', function () { window.location.href = global_base_url + "odb.html?odbpath=" + "/" });
                  //                  currentDirLink.href = global_base_url + "odb.html?odbpath=";//TODO: change to correct one
               } else if (dirArray[i] != "") {
                  var currentDirLink = document.createElement("span");
                  currentDirLink.className = "modblink";
                  currentDirLink.href = "#";
                  currentDirLink.onclick = function () {
                     updatepath(this);
                  };

                  var link = "";
                  for (var j = 1; j <= i; j++) {
                     if (dirArray[j].charAt(0) != "/") {
                        link += "/" + dirArray[j];
                     } else {
                        link += dirArray[j];
                     }
                  }
                  currentDirLink.id = link
                  currentDirLink.innerText = dirArray[i];

                  var dir_arrow = document.createElement("span");
                  dir_arrow.innerHTML = "&nbsp;&#8680;&nbsp;"

                  document.getElementById("currentDir").appendChild(dir_arrow);
               }
               document.getElementById("currentDir").appendChild(currentDirLink);
            }



         }

         // since odb data rarely changes while browsing, if any change dynamically happens, refresh the whole page
         if (JSON.stringify(global_rpc_data) != JSON.stringify(rpc.result.data[0])) {
            global_rpc_data = rpc.result.data[0];

            if (rpc.result.data != null && rpc.result.data != undefined) {

               var sub_dir = new Array();
               var odb_keys = new Array();

               //get all keys of the data object
               var keys = Object.keys(rpc.result.data[0])

               // for each key...
               keys.forEach(function (key) {
                  // if the value of the key is not an object, then it must be a key with value
                  if (typeof obj[key] !== 'object') {
                     odb_keys.push(key);
                     // if the value of the key is an object and length is 0, then it must be a sub directory
                  } else if (Object.keys(obj[key]).length === 0) {
                     sub_dir.push(key);
                  }
                  // rest of them are key properties
               });

               generateSub_Dir();
               generateODB_Keys();

               document.addEventListener("click", generateActionBar);

               custompathcache = custompath;

            }
         }

         updateLastWritten();
         updateSubDir();


      }


      function update() {

         if (custompath == "") {
            var href = decodeURIComponent(window.location.href);
            if (href.slice(-1) === "#")
               href = href.substring(0, href.length - 1);
            if (href.slice(-1) === "/")
               href = href.substring(0, href.length - 1);
            var directory = "";
            if (href.indexOf("odb.html?odbpath=") != -1) {
               var directoryPosition = href.indexOf("odb.html?odbpath=");
               directory = href.substring(directoryPosition + "odb.html?odbpath=".length, href.length);
               odb_hostname = href;
            } else {
               if (global_base_url.slice(-1) != "/")
                  global_base_url += "/";

               odb_hostname = global_base_url + "odb.html?odbpath=";
            }
            custompath = directory;
            var paths = [directory];
         } else {
            var paths = [custompath];
         }
         paths = paths.concat(subDirArray);
         mjsonrpc_db_ls(paths).then(function (rpc) {
            callback(rpc, paths[0]);
         }).then(function () {
            document.getElementById("mload").style.display = "block";
         });
      }


      function update_periodic() {
         clearTimeout(update_timer_id);
         var update_period = 1000;
         update();
         update_timer_id = setTimeout('update_periodic()', update_period);
      }
   </script>

</body>


</html>